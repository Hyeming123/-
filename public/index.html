<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì›¹ ë§ˆí”¼ì•„ ì˜¨ë¼ì¸</title>
    <style>
        body { font-family: sans-serif; transition: background 0.5s; padding: 20px; }
        body.night { background-color: #1a1a2e; color: white; }
        body.vote { background-color: #2d3436; color: white; }
        #chat-box { width: 100%; max-width: 500px; height: 300px; border: 1px solid #ccc; overflow-y: scroll; background: rgba(255, 255, 255, 0.1); margin-bottom: 10px; padding: 10px; }
        .player-item { display: inline-block; padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .player-item:hover { background: #e1e1e1; color: gray; }
        .hidden { display: none; }
        .system-msg { color: #f1c40f; font-weight: bold; }
        .player-item.dead { background-color: #555; color: #999; text-decoration: line-through; cursor: default; }
    </style>
</head>
<body>
    <h1>ğŸ•µï¸ ì›¹ ë§ˆí”¼ì•„ ê²Œì„</h1>
    <div id="setup">
        <input id="nick" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
        <button onclick="join()">ê²Œì„ ì…ì¥</button>
    </div>

    <div id="game" class="hidden">
        <h2 id="status-display">ëŒ€ê¸° ì¤‘...</h2>
        <h3 id="timer-display"></h3>
        <h3 id="my-role">ë‚´ ì—­í• : í™•ì¸ ì¤‘...</h3>
        <div id="chat-box"></div>
        <div id="input-area">
            <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" onkeypress="if(event.keyCode==13) send()">
            <button onclick="send()">ì „ì†¡</button>
        </div>
        <hr>
        <button id="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘ (4ì¸ ì´ìƒ)</button>
        <h4>í”Œë ˆì´ì–´ ëª©ë¡</h4>
        <div id="player-list"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = "";
        let currentPlayers = [];
        let currentRole = "ì‹œë¯¼";
        let timerInterval = null;

        function join() {
            const nick = document.getElementById('nick').value;
            if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
            socket.emit('join', nick);
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            myId = socket.id;
        }

        function startGame() { socket.emit('game-start'); }

        function send() {
            const msgInput = document.getElementById('msg');
            if (!msgInput.value) return;
            socket.emit('chat', msgInput.value);
            msgInput.value = '';
        }

        socket.on('update-players', (players) => {
            currentPlayers = players;
            renderPlayers(false);
        });

        socket.on('get-role', (role) => {
            currentRole = role;
            const roleEl = document.getElementById('my-role');
            roleEl.innerText = "ë‚´ ì—­í• : " + role;
            if (role === 'ë§ˆí”¼ì•„') roleEl.style.color = "#e74c3c";
            else if (role === 'ì˜ì‚¬') roleEl.style.color = "#2ecc71";
            else if (role === 'ê²½ì°°') roleEl.style.color = "#3498db";
            else roleEl.style.color = "gray";
        });

        socket.on('state-change', (data) => {
            const { state, players, duration } = data;
            currentPlayers = players;
            document.body.className = state;
            document.getElementById('status-display').innerText = `í˜„ì¬ ìƒíƒœ: ${state.toUpperCase()}`;
            startTimer(duration);

            if (state === 'vote') renderPlayers(true);
            else if (state === 'night') {
                renderPlayers(currentRole === 'ë§ˆí”¼ì•„' || currentRole === 'ì˜ì‚¬' || currentRole === 'ê²½ì°°');
            } else renderPlayers(false);

            if (state !== 'ready') document.getElementById('start-btn').classList.add('hidden');
        });

        function startTimer(duration) {
            if (timerInterval) clearInterval(timerInterval);
            let timeLeft = duration;
            const display = document.getElementById('timer-display');
            timerInterval = setInterval(() => {
                display.innerText = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
                if (--timeLeft < 0) clearInterval(timerInterval);
            }, 1000);
        }

        socket.on('msg', (msg) => {
            const box = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            if (msg.includes('ğŸ“¢') || msg.includes('ğŸŒ™') || msg.includes('â˜€ï¸') || msg.includes('ğŸ”')) {
                msgDiv.className = 'system-msg';
            }
            msgDiv.innerText = msg;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
        });

        function renderPlayers(interactive) {
            const listDiv = document.getElementById('player-list');
            listDiv.innerHTML = '';
            const currentState = document.body.className;

            currentPlayers.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item' + (player.isAlive ? '' : ' dead');
                item.innerText = player.nickname + (player.isAlive ? '' : ' (ì‚¬ë§)');

                if (interactive && player.isAlive) {
                    item.onclick = () => {
                        if (currentState === 'night') {
                            if (currentRole === 'ê²½ì°°' && player.id !== socket.id) {
                                if (confirm(player.nickname + "ë‹˜ì„ ì¡°ì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                    socket.emit('police-investigate', player.id);
                                }
                            } else if (currentRole === 'ë§ˆí”¼ì•„' && player.id !== socket.id) {
                                socket.emit('mafia-kill', player.id);
                                alert("ì²˜í˜• ëŒ€ìƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.");
                            } else if (currentRole === 'ì˜ì‚¬') {
                                socket.emit('doctor-heal', player.id);
                                alert("ì¹˜ë£Œ ëŒ€ìƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.");
                            }
                        }
                    };
                }
                listDiv.appendChild(item);
            });
        }
    </script>
</body>
</html>
