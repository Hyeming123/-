<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì›¹ ë§ˆí”¼ì•„ ì˜¨ë¼ì¸</title>
    <style>
        body {
            font-family: sans-serif;
            transition: background 0.5s;
            padding: 20px;
        }

        /* ë°¤ ìƒíƒœì¼ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        body.night {
            background-color: #1a1a2e;
            color: white;
        }

        body.vote {
            background-color: #2d3436;
            color: white;
        }

        #chat-box {
            width: 100%;
            max-width: 500px;
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            padding: 10px;
        }

        .player-item {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .player-item:hover {
            background: #e1e1e1;
            color: gray;
        }

        .hidden {
            display: none;
        }

        .system-msg {
            color: #f1c40f;
            font-weight: bold;
        }

        .player-item.dead {
            background-color: #555;
            color: #999;
            text-decoration: line-through;
            cursor: default;
        }
    </style>
</head>

<body>
    <h1>ğŸ•µï¸ ì›¹ ë§ˆí”¼ì•„ ê²Œì„</h1>

    <div id="setup">
        <input id="nick" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
        <button onclick="join()">ê²Œì„ ì…ì¥</button>
    </div>

    <div id="game" class="hidden">
        <h2 id="status-display">ëŒ€ê¸° ì¤‘...</h2>
        <h3 id="timer-display"></h3>
        <h3 id="my-role">ë‚´ ì—­í• : í™•ì¸ ì¤‘...</h3>

        <div id="chat-box"></div>

        <div id="input-area">
            <input id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" onkeypress="if(event.keyCode==13) send()">
            <button onclick="send()">ì „ì†¡</button>
        </div>

        <hr>
        <button id="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘ (4ì¸ ì´ìƒ)</button>

        <h4>í”Œë ˆì´ì–´ ëª©ë¡ (íˆ¬í‘œ ì‹œ í´ë¦­)</h4>
        <div id="player-list"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = "";
        let currentPlayers = [];
        let currentRole = "ì‹œë¯¼";

        // íƒ€ì´ë¨¸ ê°„ê²© ë³€ìˆ˜
        let timerInterval = null;
        let timeLeft = 0;

        // ì…ì¥ í•¨ìˆ˜
        function join() {
            const nick = document.getElementById('nick').value;
            if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");

            socket.emit('join', nick);
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            myId = socket.id;
        }

        // ê²Œì„ ì‹œì‘ ë²„íŠ¼
        function startGame() {
            socket.emit('game-start');
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function send() {
            const msgInput = document.getElementById('msg');
            if (!msgInput.value) return;
            socket.emit('chat', msgInput.value);
            msgInput.value = '';
        }

        // ì„œë²„ ì´ë²¤íŠ¸: í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('update-players', (players) => {
            currentPlayers = players;
            renderPlayers(false);
        });

        // ì„œë²„ ì´ë²¤íŠ¸: ì—­í•  ë¶€ì—¬
        socket.on('get-role', (role) => {
            currentRole = role;
            const roleEl = document.getElementById('my-role');
            roleEl.innerText = "ë‚´ ì—­í• : " + role;
            if (role === 'ë§ˆí”¼ì•„') {
                roleEl.style.color = "#e74c3c"; // ë¹¨ê°•
            } else if (role === 'ì˜ì‚¬') {
                roleEl.style.color = "#2ecc71"; // ì´ˆë¡
            } else {
                roleEl.style.color = "gray";
            }
        });

        // ì„œë²„ ì´ë²¤íŠ¸: ìƒíƒœ ë³€ê²½ (ë°¤/ë‚®/íˆ¬í‘œ)
        socket.on('state-change', (data) => {
            const { state, players, duration } = data;
            currentPlayers = players; // í”Œë ˆì´ì–´ ìƒíƒœ ë™ê¸°í™”
            document.body.className = state;
            document.getElementById('status-display').innerText = `í˜„ì¬ ìƒíƒœ: ${state.toUpperCase()}`;

            // íƒ€ì´ë¨¸ ì‹œì‘
            startTimer(duration);

            // ìƒíƒœì— ë”°ë¥¸ ìƒí˜¸ì‘ìš© ì„¤ì •
            if (state === 'vote') {
                renderPlayers(true); // íˆ¬í‘œ ê°€ëŠ¥
            } else if (state === 'night') {
                if (currentRole === 'ë§ˆí”¼ì•„' || currentRole === 'ì˜ì‚¬') {
                    renderPlayers(true); // ë§ˆí”¼ì•„ í‚¬ or ì˜ì‚¬ í ê°€ëŠ¥
                } else {
                    renderPlayers(false);
                }
            } else {
                renderPlayers(false); // í´ë¦­ ë¶ˆê°€
            }

            if (state !== 'ready') {
                document.getElementById('start-btn').classList.add('hidden');
            } else {
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('start-btn').innerText = "ê²Œì„ ì¬ì‹œì‘ (4ì¸ ì´ìƒ)";
            }
        });

        // íƒ€ì´ë¨¸ í•¨ìˆ˜
        function startTimer(duration) {
            if (timerInterval) clearInterval(timerInterval);
            if (duration <= 0) {
                document.getElementById('timer-display').innerText = "";
                return;
            }

            timeLeft = duration;
            const display = document.getElementById('timer-display');
            display.innerText = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;

            timerInterval = setInterval(() => {
                timeLeft--;
                display.innerText = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        // ì„œë²„ ì´ë²¤íŠ¸: ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('msg', (msg) => {
            const box = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            if (msg.includes('ğŸ“¢') || msg.includes('ğŸŒ™') || msg.includes('â˜€ï¸') || msg.includes('ğŸ”«') || msg.includes('ğŸ¥')) {
                msgDiv.className = 'system-msg';
            }
            msgDiv.innerText = msg;
            box.appendChild(msgDiv);
            box.scrollTop = box.scrollHeight;
        });

        // í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
        function renderPlayers(interactive) {
            const listDiv = document.getElementById('player-list');
            listDiv.innerHTML = '';

            // ì•ˆë‚´ ë¬¸êµ¬
            const currentState = document.body.className;
            const title = document.querySelector('h4');

            if (currentState === 'night') {
                if (currentRole === 'ë§ˆí”¼ì•„') title.innerText = 'í”Œë ˆì´ì–´ ëª©ë¡ (ì²˜í˜• ëŒ€ìƒ í´ë¦­)';
                else if (currentRole === 'ì˜ì‚¬') title.innerText = 'í”Œë ˆì´ì–´ ëª©ë¡ (ì¹˜ë£Œ ëŒ€ìƒ í´ë¦­)';
                else title.innerText = 'í”Œë ˆì´ì–´ ëª©ë¡ (ë°¤ì—ëŠ” í™œë™ ë¶ˆê°€)';
            } else if (currentState === 'vote') {
                title.innerText = 'í”Œë ˆì´ì–´ ëª©ë¡ (íˆ¬í‘œ ì‹œ í´ë¦­)';
            } else {
                title.innerText = 'í”Œë ˆì´ì–´ ëª©ë¡';
            }

            currentPlayers.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';

                if (!player.isAlive) {
                    item.classList.add('dead');
                    item.innerText = `${player.nickname} (ì‚¬ë§)`;
                } else {
                    item.innerText = player.nickname;
                }

                // ìƒí˜¸ì‘ìš© ê°€ëŠ¥ ì—¬ë¶€
                let isClickable = false;
                if (interactive && player.isAlive) {
                    if (currentState === 'vote') {
                        if (player.id !== socket.id) isClickable = true;
                    } else if (currentState === 'night') {
                        if (currentRole === 'ë§ˆí”¼ì•„') {
                            if (player.id !== socket.id) isClickable = true; // ë§ˆí”¼ì•„ëŠ” ìì‚´ ë¶ˆê°€
                        } else if (currentRole === 'ì˜ì‚¬') {
                            isClickable = true; // ì˜ì‚¬ëŠ” ìí ê°€ëŠ¥
                        }
                    }
                }

                if (isClickable) {
                    item.style.cursor = "pointer";
                    item.onclick = () => {
                        if (currentState === 'vote') {
                            socket.emit('submit-vote', player.id);
                            alert(player.nickname + "ë‹˜ì—ê²Œ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.");
                        } else if (currentState === 'night') {
                            if (currentRole === 'ë§ˆí”¼ì•„') {
                                if (confirm(player.nickname + "ë‹˜ì„ ì²˜í˜•í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                    socket.emit('mafia-kill', player.id);
                                }
                            } else if (currentRole === 'ì˜ì‚¬') {
                                if (confirm(player.nickname + "ë‹˜ì„ ì¹˜ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                    socket.emit('doctor-heal', player.id);
                                }
                            }
                        }
                    };
                } else {
                    item.style.cursor = "default";
                    item.onclick = null;
                }
                listDiv.appendChild(item);
            });
        }
    </script>
</body>

</html>
